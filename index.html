<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Saturnino Pizzaria - Controle</title>
    
    <!-- PWA Manifest & Meta Tags -->
    <meta name="theme-color" content="#d97706">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIlNhdHVybmlubyBQaXp6YXJpYSIsCiAgInNob3J0X25hbWUiOiAiU2F0dXJuaW5vIiwKICAic3RhcnRfdXJsIjogIi4iLAogICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiNmZmZmZmYiLAogICJ0aGVtZV9jb2xvciIjogIiNkOTc3MDYiLAogICJpY29ucyI6IFt7CiAgICAic3JjIjogImh0dHBzOi8vY2RuLWljb25zLXBuZy5mbGF0aWNvbi5jb20vNTEyLzcwNi83MDY5MzQucG5nIiwKICAgICJzaXplcyI6ICI1MTJ4NTEyIiwKICAgICJ0eXBlIjogImltYWdlL3BuZyIKICB9XQp9">
    
    <!-- Estilos (Tailwind CSS) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- √çcones -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- OCR Engine -->
    <script src='https://unpkg.com/tesseract.js@v4.1.1/dist/tesseract.min.js'></script>
    <!-- Biblioteca de Tempo (Day.js) -->
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>

    <style>
        .loader { border-top-color: #d97706; -webkit-animation: spinner 1.5s linear infinite; animation: spinner 1.5s linear infinite; }
        @-webkit-keyframes spinner { 0% { -webkit-transform: rotate(0deg); } 100% { -webkit-transform: rotate(360deg); } }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Fix para iOS inputs */
        input, select, textarea { font-size: 16px !important; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 font-sans pb-24 select-none">

    <!-- Cabe√ßalho -->
    <header class="bg-yellow-600 text-white p-4 shadow-md sticky top-0 z-50">
        <div class="flex justify-between items-center">
            <h1 class="text-xl font-bold flex items-center gap-2">
                <i data-lucide="pizza"></i> Saturnino
            </h1>
            <button onclick="mostrarConfig()" class="p-2 active:scale-95 transition-transform"><i data-lucide="settings"></i></button>
        </div>
        <div id="colaborador-display" class="text-sm mt-1 opacity-90 font-medium">Selecione um colaborador</div>
    </header>

    <!-- Tela Principal -->
    <main class="p-4 max-w-md mx-auto">
        
        <!-- Bot√£o de C√¢mera (CORRIGIDO) -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6 text-center border-2 border-dashed border-yellow-500 relative active:bg-yellow-50 transition-colors">
            
            <!-- TRUQUE: Input invis√≠vel mas presente no DOM (n√£o use class hidden) -->
            <input type="file" id="cameraInput" accept="image/*" capture="environment" 
                   style="opacity: 0; position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; cursor: pointer;" 
                   onchange="processarImagem(this)">

            <div class="flex flex-col items-center gap-3 pointer-events-none">
                <div class="bg-yellow-100 p-4 rounded-full text-yellow-600">
                    <i data-lucide="camera" size="48"></i>
                </div>
                <span class="font-bold text-lg">Escanear Comanda</span>
                <p class="text-xs text-gray-500">Toque aqui para fotografar</p>
            </div>
        </div>

        <!-- Status de Processamento -->
        <div id="status-ocr" class="hidden mb-4 p-4 bg-blue-100 rounded-lg text-center border border-blue-200">
            <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-8 w-8 mb-2 mx-auto"></div>
            <p class="text-sm text-blue-800 font-bold animate-pulse" id="status-texto">Lendo comanda...</p>
        </div>

        <!-- Lista de Pedidos em Produ√ß√£o -->
        <h2 class="font-bold text-gray-700 mb-2 flex items-center gap-2 px-1">
            <i data-lucide="flame" class="text-orange-500"></i> Em Produ√ß√£o
        </h2>
        <div id="lista-producao" class="space-y-3 mb-8 min-h-[100px]">
            <!-- Itens inseridos via JS -->
            <p class="text-center text-gray-400 text-sm py-8 bg-white rounded-lg shadow-sm">Nenhum pedido no forno.</p>
        </div>

    </main>

    <!-- Modal de Detalhes do Pedido -->
    <div id="modal-pedido" class="fixed inset-0 bg-black bg-opacity-60 hidden z-[60] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-xl w-full max-w-md p-5 shadow-2xl transform transition-all scale-100">
            <h3 class="text-xl font-bold mb-4 text-gray-800 border-b pb-2" id="modal-titulo">Confirmar Dados</h3>
            
            <form id="form-pedido" onsubmit="salvarPedido(event)">
                <input type="hidden" id="pedido-id-interno">
                <input type="hidden" id="pedido-acao">

                <div class="grid gap-4 mb-6">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">N¬∫ Pedido</label>
                        <input type="tel" id="inp-numero" class="w-full border-2 border-gray-200 p-3 rounded-lg text-lg font-bold focus:border-yellow-500 outline-none" placeholder="1234" required>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Sabor</label>
                            <input type="text" id="inp-sabor" class="w-full border p-2 rounded-lg" placeholder="Ex: Calabresa" required>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Tamanho</label>
                            <select id="inp-tamanho" class="w-full border p-2 rounded-lg bg-white">
                                <option value="Grande">Grande</option>
                                <option value="M√©dia">M√©dia</option>
                                <option value="Pequena">Pequena</option>
                                <option value="Gigante">Gigante</option>
                                <option value="Broto">Broto</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Ocorr√™ncias (Opcional)</label>
                        <textarea id="inp-ocorrencia" class="w-full border p-2 rounded-lg text-sm" rows="2" placeholder="Ex: Atraso, Borda queimada..."></textarea>
                    </div>
                </div>

                <div class="flex gap-3">
                    <button type="button" onclick="fecharModal('modal-pedido')" class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-300">Cancelar</button>
                    <button type="submit" class="flex-1 bg-yellow-600 text-white py-3 rounded-lg font-bold shadow-md hover:bg-yellow-700">Confirmar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Configura√ß√µes/Relat√≥rios -->
    <div id="modal-config" class="fixed inset-0 bg-black bg-opacity-60 hidden z-[60] flex items-end sm:items-center justify-center backdrop-blur-sm">
        <div class="bg-white rounded-t-2xl sm:rounded-xl w-full max-w-md p-6 h-[85vh] sm:h-auto overflow-y-auto shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-800">Menu & Relat√≥rios</h3>
                <button onclick="fecharModal('modal-config')" class="bg-gray-100 p-2 rounded-full"><i data-lucide="x"></i></button>
            </div>

            <div class="mb-6 bg-gray-50 p-4 rounded-lg border">
                <label class="block text-sm font-bold mb-2 text-gray-600">Quem est√° usando?</label>
                <div class="flex gap-2 mb-2">
                    <select id="select-colaborador" class="w-full border p-2 rounded-lg bg-white" onchange="mudarColaborador()">
                        <option value="">Selecione...</option>
                    </select>
                </div>
                <div class="flex gap-2">
                    <input type="text" id="novo-colaborador" placeholder="Novo nome" class="border p-2 rounded-lg flex-1 text-sm">
                    <button onclick="addColaborador()" class="bg-green-600 text-white px-4 rounded-lg text-sm font-bold">Add</button>
                </div>
            </div>

            <hr class="my-4 border-gray-200">

            <div>
                <h4 class="font-bold mb-3 flex items-center gap-2"><i data-lucide="bar-chart"></i> Relat√≥rio do Dia</h4>
                <div class="grid grid-cols-2 gap-3 text-center mb-4">
                    <div class="bg-yellow-50 p-3 rounded-xl border border-yellow-100">
                        <span class="block text-3xl font-bold text-yellow-600" id="rel-total">0</span>
                        <span class="text-xs text-gray-500 font-bold uppercase">Pizzas Hoje</span>
                    </div>
                    <div class="bg-blue-50 p-3 rounded-xl border border-blue-100">
                        <span class="block text-3xl font-bold text-blue-600" id="rel-media">0m</span>
                        <span class="text-xs text-gray-500 font-bold uppercase">Tempo M√©dio</span>
                    </div>
                </div>
                
                <h5 class="text-xs font-bold text-gray-400 uppercase mb-2">√öltimos Pedidos Finalizados</h5>
                <ul id="lista-historico" class="text-sm space-y-2 mb-6 max-h-40 overflow-y-auto bg-gray-50 p-2 rounded border">
                    <!-- Hist√≥rico -->
                    <li class="text-center text-gray-400 text-xs">Nenhum pedido finalizado hoje.</li>
                </ul>

                <button onclick="enviarWhatsapp()" class="w-full bg-green-500 active:bg-green-600 text-white p-4 rounded-xl flex items-center justify-center gap-2 font-bold shadow-lg transition-colors">
                    <i data-lucide="message-circle"></i> Enviar no WhatsApp
                </button>
                
                <button onclick="limparDados()" class="mt-6 text-red-500 text-xs w-full text-center py-2 border border-red-100 rounded hover:bg-red-50">Limpar hist√≥rico do aparelho</button>
            </div>
        </div>
    </div>

    <!-- Barra de Navega√ß√£o Inferior -->
    <nav class="fixed bottom-0 w-full bg-white border-t border-gray-200 flex justify-around p-2 z-40 pb-safe">
        <button onclick="fecharModal('modal-config')" class="text-yellow-600 flex flex-col items-center p-2 flex-1 active:bg-gray-50">
            <i data-lucide="home"></i>
            <span class="text-[10px] font-bold mt-1">Produ√ß√£o</span>
        </button>
        <button onclick="mostrarConfig()" class="text-gray-400 flex flex-col items-center p-2 flex-1 active:bg-gray-50 hover:text-gray-600">
            <i data-lucide="bar-chart-2"></i>
            <span class="text-[10px] font-bold mt-1">Relat√≥rios</span>
        </button>
    </nav>

    <script>
        // --- 1. Estado e Inicializa√ß√£o ---
        let db = {
            colaboradores: JSON.parse(localStorage.getItem('saturnino_colaboradores')) || ['Pizzaiolo 1', 'Pizzaiolo 2'],
            pedidosEmAndamento: JSON.parse(localStorage.getItem('saturnino_andamento')) || [],
            historico: JSON.parse(localStorage.getItem('saturnino_historico')) || [],
            colaboradorAtual: localStorage.getItem('saturnino_atual') || ''
        };

        // Inicializa √≠cones e tela
        lucide.createIcons();
        atualizarUI();

        // --- 2. Fun√ß√µes de OCR e Processamento ---
        async function processarImagem(input) {
            if (!db.colaboradorAtual) {
                alert("‚ö†Ô∏è Selecione quem est√° produzindo antes de come√ßar!");
                mostrarConfig();
                input.value = ""; 
                return;
            }

            const file = input.files[0];
            if (!file) return;

            // UI Loading
            document.getElementById('status-ocr').classList.remove('hidden');
            document.getElementById('status-texto').innerText = "Processando imagem...";

            try {
                const worker = await Tesseract.createWorker('por');
                const ret = await worker.recognize(file);
                await worker.terminate();
                
                const textoExtraido = ret.data.text;
                
                // Regex melhorado para comandas
                let numeroPedido = extrairNumeroPedido(textoExtraido);
                let sabor = ""; 
                let tamanho = extrairTamanho(textoExtraido);

                // Verifica se √© START ou STOP
                const index = db.pedidosEmAndamento.findIndex(p => p.numero == numeroPedido);
                
                abrirModalConfirmacao(index, numeroPedido, sabor, tamanho);

            } catch (err) {
                console.error(err);
                alert("N√£o foi poss√≠vel ler a imagem. Digite manualmente.");
                abrirModalConfirmacao(-1, "", "", ""); 
            } finally {
                document.getElementById('status-ocr').classList.add('hidden');
                input.value = ""; // Reset input para permitir nova foto igual
            }
        }

        function extrairNumeroPedido(texto) {
            // Remove espa√ßos extras
            texto = texto.replace(/\s+/g, ' ');
            // Tenta achar padr√µes: "Pedido 1234", "#1234", "Senha 1234"
            const regex = /(?:pedido|senha|cupom|n¬∫|#)[:\s]*(\d{3,5})/i;
            const match = texto.match(regex);
            if (match) return match[1];
            
            // Fallback: Primeiro n√∫mero grande isolado
            const regexNum = /\b\d{3,5}\b/;
            const matchNum = texto.match(regexNum);
            return matchNum ? matchNum[0] : "";
        }

        function extrairTamanho(texto) {
            texto = texto.toLowerCase();
            if (texto.includes("fam") || texto.includes("gig")) return "Gigante";
            if (texto.includes("gra")) return "Grande";
            if (texto.includes("med") || texto.includes("m√©d")) return "M√©dia";
            if (texto.includes("peq")) return "Pequena";
            if (texto.includes("bro")) return "Broto";
            return "Grande";
        }

        // --- 3. L√≥gica de UI (Modais e Formul√°rios) ---
        function abrirModalConfirmacao(indexExistente, numero, sabor, tamanho) {
            const modal = document.getElementById('modal-pedido');
            const titulo = document.getElementById('modal-titulo');
            const inpNum = document.getElementById('inp-numero');
            const inpSabor = document.getElementById('inp-sabor');
            const inpTam = document.getElementById('inp-tamanho');
            
            inpNum.value = numero || '';
            inpSabor.value = sabor || '';
            if(tamanho) inpTam.value = tamanho;

            document.getElementById('pedido-id-interno').value = indexExistente;

            if (indexExistente > -1) {
                titulo.innerText = "‚úÖ Finalizar Pedido";
                document.getElementById('pedido-acao').value = 'stop';
                const dadosSalvos = db.pedidosEmAndamento[indexExistente];
                inpSabor.value = dadosSalvos.sabor;
                inpTam.value = dadosSalvos.tamanho;
                inpNum.readOnly = true; 
                inpNum.classList.add('bg-gray-100');
            } else {
                titulo.innerText = "üî• Iniciar Produ√ß√£o";
                document.getElementById('pedido-acao').value = 'start';
                inpNum.readOnly = false;
                inpNum.classList.remove('bg-gray-100');
            }

            modal.classList.remove('hidden');
        }

        function fecharModal(id) {
            document.getElementById(id).classList.add('hidden');
        }

        function salvarPedido(e) {
            e.preventDefault();
            const numero = document.getElementById('inp-numero').value;
            const sabor = document.getElementById('inp-sabor').value;
            const tamanho = document.getElementById('inp-tamanho').value;
            const ocorrencia = document.getElementById('inp-ocorrencia').value;
            const acao = document.getElementById('pedido-acao').value;
            const index = document.getElementById('pedido-id-interno').value;
            
            const agora = new Date();

            if (acao === 'start') {
                const duplicado = db.pedidosEmAndamento.find(p => p.numero == numero);
                if(duplicado) {
                    alert("Esse pedido j√° est√° em produ√ß√£o!");
                    return;
                }

                const novoPedido = {
                    numero,
                    sabor,
                    tamanho,
                    inicio: agora.toISOString(),
                    colaborador: db.colaboradorAtual,
                    ocorrencia
                };
                db.pedidosEmAndamento.push(novoPedido);
            } else {
                const pedido = db.pedidosEmAndamento[index];
                const inicio = new Date(pedido.inicio);
                const diffMs = agora - inicio; 
                const diffMin = Math.round(diffMs / 60000);

                const finalizado = {
                    ...pedido,
                    fim: agora.toISOString(),
                    duracaoMinutos: diffMin || 1, // M√≠nimo 1 min
                    ocorrencia: ocorrencia ? (pedido.ocorrencia ? pedido.ocorrencia + " | " + ocorrencia : ocorrencia) : pedido.ocorrencia
                };

                db.historico.push(finalizado);
                db.pedidosEmAndamento.splice(index, 1);
            }

            salvarBanco();
            atualizarUI();
            fecharModal('modal-pedido');
            document.getElementById('form-pedido').reset();
        }

        // --- 4. Persist√™ncia e Atualiza√ß√£o ---
        function salvarBanco() {
            localStorage.setItem('saturnino_andamento', JSON.stringify(db.pedidosEmAndamento));
            localStorage.setItem('saturnino_historico', JSON.stringify(db.historico));
            localStorage.setItem('saturnino_colaboradores', JSON.stringify(db.colaboradores));
            localStorage.setItem('saturnino_atual', db.colaboradorAtual);
        }

        function atualizarUI() {
            const displayColab = document.getElementById('colaborador-display');
            displayColab.innerText = db.colaboradorAtual ? `Ol√°, ${db.colaboradorAtual}` : 'Toque na engrenagem para entrar';
            
            const lista = document.getElementById('lista-producao');
            lista.innerHTML = '';
            
            if (db.pedidosEmAndamento.length === 0) {
                lista.innerHTML = '<div class="text-center text-gray-400 text-sm py-8 bg-white rounded-lg border border-gray-100 shadow-sm flex flex-col items-center gap-2"><i data-lucide="chef-hat"></i><span>Nenhum pedido no forno.</span></div>';
            } else {
                db.pedidosEmAndamento.forEach(p => {
                    const horaInicio = dayjs(p.inicio).format('HH:mm');
                    lista.innerHTML += `
                        <div class="bg-white p-4 rounded-lg shadow-md border-l-4 border-yellow-500 flex justify-between items-center relative overflow-hidden">
                            <div class="z-10">
                                <span class="font-black text-xl text-gray-800">#${p.numero}</span>
                                <p class="text-sm font-bold text-gray-600">${p.sabor}</p>
                                <p class="text-xs text-gray-400 mt-1">${p.tamanho} ‚Ä¢ ${horaInicio} ‚Ä¢ ${p.colaborador}</p>
                            </div>
                            <div class="text-orange-500 bg-orange-50 px-3 py-1 rounded-full text-xs font-bold animate-pulse flex items-center gap-1">
                                <i data-lucide="flame" size="14"></i> Assando
                            </div>
                        </div>
                    `;
                });
            }
            lucide.createIcons();
            atualizarRelatorios();
        }

        // --- 5. Relat√≥rios e Configura√ß√µes ---
        function mostrarConfig() {
            const modal = document.getElementById('modal-config');
            const select = document.getElementById('select-colaborador');
            
            select.innerHTML = '<option value="">Selecione...</option>';
            db.colaboradores.forEach(c => {
                select.innerHTML += `<option value="${c}" ${c === db.colaboradorAtual ? 'selected' : ''}>${c}</option>`;
            });

            modal.classList.remove('hidden');
            atualizarRelatorios();
        }

        function mudarColaborador() {
            const select = document.getElementById('select-colaborador');
            db.colaboradorAtual = select.value;
            salvarBanco();
            atualizarUI();
        }

        function addColaborador() {
            const nome = document.getElementById('novo-colaborador').value;
            if (nome) {
                db.colaboradores.push(nome);
                document.getElementById('novo-colaborador').value = '';
                salvarBanco();
                mostrarConfig(); 
            }
        }

        function atualizarRelatorios() {
            const hoje = dayjs().format('YYYY-MM-DD');
            const historicoHoje = db.historico.filter(p => dayjs(p.fim).format('YYYY-MM-DD') === hoje);

            document.getElementById('rel-total').innerText = historicoHoje.length;

            let somaTempo = 0;
            const listaHist = document.getElementById('lista-historico');
            listaHist.innerHTML = '';

            if(historicoHoje.length === 0) {
                 listaHist.innerHTML = '<li class="text-center text-gray-400 text-xs py-2">Nenhum pedido finalizado hoje.</li>';
            } else {
                // Mostra os √∫ltimos 5
                historicoHoje.slice().reverse().forEach(p => {
                    somaTempo += p.duracaoMinutos;
                    listaHist.innerHTML += `
                        <li class="border-b border-gray-100 py-2 flex justify-between items-center last:border-0">
                            <div>
                                <span class="block font-bold text-gray-700">#${p.numero} - ${p.sabor}</span>
                                <span class="text-[10px] text-gray-400">${dayjs(p.fim).format('HH:mm')} ‚Ä¢ ${p.colaborador}</span>
                            </div>
                            <span class="font-bold text-blue-600 bg-blue-50 px-2 py-1 rounded text-xs">${p.duracaoMinutos} min</span>
                        </li>
                    `;
                });
            }

            const media = historicoHoje.length ? Math.round(somaTempo / historicoHoje.length) : 0;
            document.getElementById('rel-media').innerText = media + 'm';
        }

        function enviarWhatsapp() {
            const hojeFormatado = dayjs().format('DD/MM/YYYY');
            const hojeISO = dayjs().format('YYYY-MM-DD');
            const historicoHoje = db.historico.filter(p => dayjs(p.fim).format('YYYY-MM-DD') === hojeISO);
            
            if(historicoHoje.length === 0) {
                alert("Nenhum dado para enviar hoje.");
                return;
            }

            let total = historicoHoje.length;
            let somaTempo = 0;
            let ocorrencias = [];
            let sabores = {};

            historicoHoje.forEach(p => {
                somaTempo += p.duracaoMinutos;
                if(p.ocorrencia) ocorrencias.push(`‚ö†Ô∏è Ped #${p.numero}: ${p.ocorrencia}`);
                
                if(!sabores[p.sabor]) sabores[p.sabor] = 0;
                sabores[p.sabor]++;
            });

            const media = total ? Math.round(somaTempo / total) : 0;

            let msg = `üçï *RELAT√ìRIO SATURNINO - ${hojeFormatado}* üçï\n\n`;
            msg += `üìä *Resumo:*\n`;
            msg += `‚úÖ Total Produzido: *${total} pizzas*\n`;
            msg += `‚è±Ô∏è Tempo M√©dio: *${media} min*\n`;
            msg += `--------------------------------\n`;
            
            msg += `üìã *Por Sabor:*\n`;
            for (const [sab, qtd] of Object.entries(sabores)) {
                msg += `‚Ä¢ ${sab}: ${qtd}\n`;
            }

            if(ocorrencias.length > 0) {
                msg += `\n--------------------------------\n`;
                msg += `üö® *Ocorr√™ncias:*\n`;
                msg += ocorrencias.join('\n');
            }

            msg += `\n_Gerado pelo App Saturnino_`;

            const url = `https://wa.me/?text=${encodeURIComponent(msg)}`;
            window.open(url, '_blank');
        }
        
        function limparDados() {
            if(confirm("ATEN√á√ÉO: Isso apagar√° todo o hist√≥rico deste celular. Deseja continuar?")) {
                localStorage.clear();
                location.reload();
            }
        }
    </script>
</body>
</html>